#!/bin/bash
clear
NC='\033[0m'

PERMISSION() {
    # Alamat URL lisensi disimpan dalam variabel agar mudah diubah
    local LICENSE_URL="https://raw.githubusercontent.com/sehuadri/scnew/main/ip-bot"
    
    # Dapatkan informasi IP dan tanggal saat ini
    local MYIP=$(curl -sS ipv4.icanhazip.com)
    local TODAY_DATE=$(date +'%Y-%m-%d')

    # Cari baris di mana kolom ke-4 cocok persis dengan MYIP.
    # Ini lebih akurat daripada grep dan menghilangkan kebutuhan cek kedua.
    local AUTHORIZED_ENTRY=$(curl -sS "$LICENSE_URL" | awk -v myip="$MYIP" '$4 == myip' | head -1)

    # Cek apakah IP ditemukan di kolom yang benar.
    if [[ -z "$AUTHORIZED_ENTRY" ]]; then
        echo -e "\033[1;91mPermission Denied (IP Not Registered)\033[0m"
        echo -e "\033[1;97mAkses Ditolak (IP Tidak Terdaftar)${NC}"
        read -n 1 -s -r -p "Press [ Enter ] to Exit"
        exit 1
    fi

    # Ekstrak hanya tanggal/status dari kolom ke-3.
    local EXP_STATUS=$(echo "$AUTHORIZED_ENTRY" | awk '{print $3}')

    # Lakukan perbandingan tanggal/status.
    if [[ "$EXP_STATUS" == "lifetime" ]]; then
        echo -e "\033[1;92mPermission Accepted (Lifetime User)\033[0m"
        echo -e "\033[1;97mAkses Diizinkan (Pengguna Lifetime)${NC}"
    elif [[ "$TODAY_DATE" < "$EXP_STATUS" ]]; then
        echo -e "\033[1;92mPermission Accepted\033[0m"
        echo -e "\033[1;97mAkses Diizinkan${NC}"
    elif [[ "$TODAY_DATE" == "$EXP_STATUS" ]]; then
        echo -e "\033[1;93mPermission Accepted (Today is Expiry Date)\033[0m"
        echo -e "\033[1;97mAkses Diizinkan (Hari Ini Kadaluarsa)${NC}"
    else
        echo -e "\033[1;91mPermission Denied (Expired)\033[0m"
        echo -e "\033[1;97mAkses Ditolak (Kadaluarsa)${NC}"
        read -n 1 -s -r -p "Press [ Enter ] to Exit"
        exit 1
    fi
}

# Contoh pemanggilan fungsi
PERMISSION
clear
greenBe="\033[5;32m"
cd /etc/systemd/system/
rm -rf vermilion.service
cd
grenbo="\e[92;1m"
NC='\e[0m'

cd /usr/bin
rm -rf vermilion
rm -rf vermilion.zip
sudo apt update
sudo apt install pip
apt install unzip
apt install neofetch -y
cd /usr/bin
wget https://raw.githubusercontent.com/sehuadri/project/main/bot/vermilion.zip
unzip -P miqdad12 vermilion.zip
chmod +x /usr/bin/vermilion/*
rm -rf vermilion.zip
clear
pip3 install python-telegram-bot==13.7
pip3 install requests
clear
cd

echo ""
echo -e "\033[97m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
echo -e "\033[1;93mADD BOT REGIS IP\033[0m"
echo -e "\033[97m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
read -e -p "Masukkan ID Telegram :" admin
echo -e ''$admin'' >> /usr/bin/vermilion/lite.txt
echo -e "\033[97m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
clear

cat > /etc/systemd/system/vermilion.service << END
[Unit]
Description=Simple vermilion - @vermilion
After=network.target

[Service]
WorkingDirectory=/usr/bin/vermilion
ExecStart=/usr/bin/python3  daftarip.py
Restart=always

[Install]
WantedBy=multi-user.target
END

systemctl start vermilion 
systemctl enable vermilion
systemctl restart vermilion
cd /root
rm -rf bot.sh
rm -rf bot.sh.1
clear
echo -e "\e[5;32mSuccessfully Install Bot Regis IP, type /start on your bot \e[0m"
sleep 1
read -n 1 -s -r -p "Press [ Enter ] to back on menu"
m-regis
