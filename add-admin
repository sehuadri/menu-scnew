#!/bin/bash
clear
NC='\033[0m'

PERMISSION() {
    # Alamat URL lisensi disimpan dalam variabel agar mudah diubah
    local LICENSE_URL="https://raw.githubusercontent.com/sehuadri/scnew/main/ip-bot"
    
    # Dapatkan informasi IP dan tanggal saat ini
    local MYIP=$(curl -sS ipv4.icanhazip.com)
    local TODAY_DATE=$(date +'%Y-%m-%d')

    # Cari baris di mana kolom ke-4 cocok persis dengan MYIP.
    # Ini lebih akurat daripada grep dan menghilangkan kebutuhan cek kedua.
    local AUTHORIZED_ENTRY=$(curl -sS "$LICENSE_URL" | awk -v myip="$MYIP" '$4 == myip' | head -1)

    # Cek apakah IP ditemukan di kolom yang benar.
    if [[ -z "$AUTHORIZED_ENTRY" ]]; then
        echo -e "\033[1;91mPermission Denied (IP Not Registered)\033[0m"
        echo -e "\033[1;97mAkses Ditolak (IP Tidak Terdaftar)${NC}"
        read -n 1 -s -r -p "Press [ Enter ] to Exit"
        exit 1
    fi

    # Ekstrak hanya tanggal/status dari kolom ke-3.
    local EXP_STATUS=$(echo "$AUTHORIZED_ENTRY" | awk '{print $3}')

    # Lakukan perbandingan tanggal/status.
    if [[ "$EXP_STATUS" == "lifetime" ]]; then
        echo -e "\033[1;92mPermission Accepted (Lifetime User)\033[0m"
        echo -e "\033[1;97mAkses Diizinkan (Pengguna Lifetime)${NC}"
    elif [[ "$TODAY_DATE" < "$EXP_STATUS" ]]; then
        echo -e "\033[1;92mPermission Accepted\033[0m"
        echo -e "\033[1;97mAkses Diizinkan${NC}"
    elif [[ "$TODAY_DATE" == "$EXP_STATUS" ]]; then
        echo -e "\033[1;93mPermission Accepted (Today is Expiry Date)\033[0m"
        echo -e "\033[1;97mAkses Diizinkan (Hari Ini Kadaluarsa)${NC}"
    else
        echo -e "\033[1;91mPermission Denied (Expired)\033[0m"
        echo -e "\033[1;97mAkses Ditolak (Kadaluarsa)${NC}"
        read -n 1 -s -r -p "Press [ Enter ] to Exit"
        exit 1
    fi
}


PERMISSION
clear
BIGreen='\033[1;92m' # Hijau terang (bold)
BIWhite='\033[1;97m' # Putih terang (bold)
NC='\033[0m'         # Reset warna

# Path ke file admin
ADMIN_FILE="/usr/bin/vermilion/lite.txt"

# Pastikan file ada, jika tidak buat file kosong (dengan devnull untuk suppress error)
[ -f "$ADMIN_FILE" ] || touch "$ADMIN_FILE" 2>/dev/null

clear
echo -e "${BIGreen}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${BIWhite}           ADD ADMIN BOT REGIS          ${NC}"
echo -e "${BIGreen}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

# Minta input ID admin baru
read -p "Input ID Telegram: " ADMIN_ID

# Pastikan input hanya angka
if [[ ! "$ADMIN_ID" =~ ^[0-9]+$ ]]; then
    echo -e "${BIGreen}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BIWhite}Error: ID harus berupa angka!${NC}"
    echo -e "${BIGreen}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    read -n 1 -s -r -p "Press [ Enter ] to back on menu"
    m-regis
fi

# Cek apakah ID sudah ada dalam daftar (dengan devnull untuk suppress error)
if grep -Fxq "$ADMIN_ID" "$ADMIN_FILE" 2>/dev/null; then
    echo -e "${BIGreen}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BIWhite}ID $ADMIN_ID sudah terdaftar sebagai admin!${NC}"
    echo -e "${BIGreen}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
else
    echo "$ADMIN_ID" >> "$ADMIN_FILE" 2>/dev/null
    echo -e "${BIGreen}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BIWhite}ID $ADMIN_ID berhasil ditambahkan sebagai admin!${NC}"
    echo -e "${BIGreen}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
fi

read -n 1 -s -r -p "Press [ Enter ] to back on menu"
m-regis
